##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##


# Default server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
         listen 443 ssl default_server;
         listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
         include snippets/snakeoil.conf;


        gzip on;
        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        etag on;
        expires 60;
        #expires 10;

        root /srv/www/website/public;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name test.flex.io;

        # http_x_forwarded_proto contains the protocol used
        # between the users browser and the load balancer;
        # and between the load balancer and the web server,
        # http is used; this line ensures that the user
        # is browsing with https
        if ($http_x_forwarded_proto != "https") {
            rewrite ^ https://$server_name$request_uri? permanent;
        }

        # rule to make sure that https://www.flex.io/docs/ loads docs.html
        #rewrite ^/docs/$ /docs last;

        # rewrite /examples to /templates
        rewrite ^/examples(.*)$ /templates$1 permanent;

        # blog author redirects
        rewrite ^/blog/author/kenflex-io/?$ /blog/authors/ken-kaczmarek permanent;
        rewrite ^/blog/author/nateflex-io/?$ /blog/authors/nate-williams permanent;
        rewrite ^/blog/author/daveflex-io/?$ /blog/authors/dave-williams permanent;
        rewrite ^/blog/author/benflex-io/?$ /blog/authors/ben-williams permanent;
        rewrite ^/blog/author/juneflex-io/?$ /blog/authors/june-wu permanent;
        rewrite ^/blog/author/isabelleflex-io/?$ /blog/authors/isabelle-lim permanent;
        rewrite ^/blog/author/eileenflex-io/?$ /blog/authors/eileen-li permanent;
        rewrite ^/blog/author/pauloflex-io/?$ /blog/authors/paulo-nascimento permanent;
        rewrite ^/blog/author/tylerflex-io/?$ /blog/authors/tyler-patterson permanent;

        # use case path redirects
        rewrite ^/use-cases/data-feeds/bulk-load-csv-files-into-elasticsearch /use-cases/bulk-load-csv-files-into-elasticsearch permanent;
        rewrite ^/use-cases/data-feeds/convert-csv-to-json-and-create-a-refreshable-data-stream /use-cases/clean-csv-file-convert-to-json-stream permanent;
        rewrite ^/use-cases/data-feeds/convert-csv-to-json /use-cases/convert-csv-to-json-with-ajax-call permanent;
        rewrite ^/use-cases/image-processing/convert-multiple-images-to-thumbnails /use-cases/convert-multiple-images-to-thumbnails permanent;
        rewrite ^/use-cases/charts-and-graphs/create-a-chart-with-chart-js-from-a-csv-file /use-cases/create-chart-with-chart-js-from-csv-file permanent;
        rewrite ^/use-cases/data-visualization/how-to-display-a-dynamic-interactive-d3js-visualization-on-github-pages /use-cases/display-interactive-d3-js-visualization-github-pages permanent;
        rewrite ^/use-cases/data-feeds/run-python-code-in-a-browser /use-cases/run-python-code-in-browser permanent;
        rewrite ^/use-cases/data-feeds/standardize-column-names-in-a-csv-file-to-match-an-upload-template-format /use-cases/reformat-csv-standardize-column-names-template permanent;

        # use case => template redirects
        rewrite ^/use-cases/convert-csv-to-json-with-ajax-call /templates/convert-csv-file-on-the-web-to-json permanent;
        rewrite ^/use-cases/run-python-code-in-browser /templates/create-serverless-function-using-python permanent;
        rewrite ^/use-cases/automate-web-page-screenshot-capture-url-png /templates/render-webpage-to-image permanent;
        rewrite ^/use-cases/automate-web-page-snapshots-batch-convert-url-pdf /templates/render-webpage-to-pdf permanent;

        # use case => tutorial redirects
        rewrite ^/use-cases/create-chart-with-chart-js-from-csv-file /docs/tutorials/create-chart-with-chart-js-from-csv-file permanent;
        rewrite ^/use-cases/add-dynamic-content-to-gatsby-site /docs/tutorials/add-dynamic-content-static-website-jekyll-hugo-hexo permanent;
        rewrite ^/use-cases/add-dynamic-content-to-hugo-site /docs/tutorials/add-dynamic-content-static-website-jekyll-hugo-hexo permanent;
        rewrite ^/use-cases/add-dynamic-content-to-jekyll-site /docs/tutorials/add-dynamic-content-static-website-jekyll-hugo-hexo permanent;
        rewrite ^/use-cases/bulk-load-csv-files-into-elasticsearch /docs/tutorials/bulk-load-csv-files-elasticsearch-indices permanent;
        rewrite ^/use-cases/load-database-tables-into-elasticsearch /docs/tutorials/bulk-load-csv-files-elasticsearch-indices permanent;

        # docs redirects
        rewrite ^/docs/getting-started /docs/quick-start permanent;
        rewrite ^/docs/web-app /docs permanent;

        # custom error page for 404 requests
        error_page 404 /404.html;

        #location = /404.html {
        #        root /srv/www/html;
        #        internal;
        #}

        #location / {
        #       # First attempt to serve request as file, then
        #       # as directory, then fall back to displaying a 404.
        #       try_files $uri.html $uri $uri/ =404;
        #}

        location / {
                rewrite ^(/.*)\.html(\?.*)?$ $1$2;
                rewrite ^/(.*)/$ /$1;

                index index.html;
                try_files $uri/index.html $uri.html $uri/ $uri =404;
        }

        location ~ \.php$ {
                include /etc/nginx/fastcgi.conf;
                fastcgi_pass unix:/run/php/php7.0-fpm.sock;
        }

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php7.0-cgi alone:
        #       fastcgi_pass 127.0.0.1:9000;
        #       # With php7.0-fpm:
        #       fastcgi_pass unix:/run/php/php7.0-fpm.sock;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
