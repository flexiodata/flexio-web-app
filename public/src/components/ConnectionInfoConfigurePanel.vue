<template>
  <div>
    <div class="flex flex-row items-center mb4">
      <service-icon class="br1 square-3 mr3" :url="curl" :type="ctype" />
      <div class="f3 fw6 lh-title">
        <span v-if="isNew">New Connection</span>
        <span v-else>{{connection.name}}</span>
      </div>
      <div class="code light-silver ml2 ml3-ns" v-if="false && identifier.length > 0">({{identifier}})</div>
    </div>

    <div class="mv3">
      <div class="flex flex-column flex-row-ns">
        <ui-textbox
          class="flex-fill mr4-ns"
          autocomplete="off"
          placeholder="Name"
          label="Name"
          floating-label
          help=" "
          required
          v-model="name"
          :autofocus="true"
        />
        <ui-textbox
          class="flex-fill"
          autocomplete="off"
          placeholder="Alias"
          label="Alias"
          floating-label
          help=" "
          v-model="ename"
        />
      </div>

      <div class="flex flex-column flex-row-ns">
        <value-select
          class="w-25-ns min-w4-ns"
          placeholder="Method"
          label="Method"
          floating-label
          :options="method_options"
          v-model="method"
        />
        <ui-textbox
          class="flex-fill ml4-ns"
          autocomplete="off"
          placeholder="URL"
          label="URL"
          floating-label
          help=" "
          v-model="url"
        />
      </div>
    </div>

    <div class="mv3">
      <ui-tabs v-if="is_inited">
        <ui-tab id="authorization" title="Authorization">
          <div class="ma3 mw6">
            <value-select
              placeholder="Authorization Type"
              label="Authorization Type"
              floating-label
              :options="auth_options"
              v-model="auth"
            />
            <ui-textbox
              autocomplete="off"
              placeholder="Username"
              label="Username"
              floating-label
              help=" "
              v-model="username"
              v-if="auth == 'basic'"
            />
            <ui-textbox
              type="password"
              autocomplete="off"
              placeholder="Password"
              label="Password"
              floating-label
              help=" "
              v-model="password"
              v-if="auth == 'basic'"
            />
            <ui-textbox
              type="password"
              autocomplete="off"
              placeholder="Token"
              label="Token"
              floating-label
              help=" "
              v-model="token"
              v-if="auth == 'bearer'"
            />
            <ui-textbox
              type="password"
              autocomplete="off"
              placeholder="Access Token"
              label="Access Token"
              floating-label
              help=" "
              v-model="access_token"
              v-if="auth == 'oauth2'"
            />
            <ui-textbox
              type="password"
              autocomplete="off"
              placeholder="Refresh Token"
              label="Refresh Token"
              help=" "
              v-model="refresh_token"
              v-if="auth == 'oauth2'"
            />
            <ui-textbox
              autocomplete="off"
              placeholder="Expires"
              label="Expires"
              floating-label
              help=" "
              v-model="expires"
              v-if="auth == 'oauth2'"
            />
          </div>
        </ui-tab>

        <ui-tab id="form-data" title="Form Data">
          <div class="ma3">
            <keypair-item
              :item="{ key: 'Key', val: 'Value' }"
              :is-static="true"
              v-if="false"
            />
            <keypair-item
              v-for="(item, index) in data"
              :key="index"
              :item="item"
              :index="index"
              :count="data.length"
              @change="onFormDataItemChange"
              @delete="onFormDataItemDelete"
            />
          </div>
        </ui-tab>

        <ui-tab id="headers" title="Headers">
          <div class="ma3">
            <keypair-item
              :item="{ key: 'Key', val: 'Value' }"
              :is-static="true"
              v-if="false"
            />
            <keypair-item
              v-for="(item, index) in headers"
              :key="index"
              :item="item"
              :index="index"
              :count="headers.length"
              @change="onHeaderItemChange"
              @delete="onHeaderItemDelete"
            />
          </div>
        </ui-tab>
      </ui-tabs>
    </div>

    <div class="flex flex-row justify-end mv4 pa3 bt b--black-05 bg-near-white">
      <btn btn-md class="b ttu blue mr2" :disabled="!isNew && !is_changed" @click="onCancel">Cancel</btn>
      <btn btn-md btn-primary class="ttu b" :disabled="!isNew && !is_changed" @click="onSave">
        <span v-if="isNew">Create Connection</span>
        <span v-else>Save Changes</span>
      </btn>
    </div>
  </div>
</template>

<script>
  import { CONNECTION_TYPE_HTTP } from '../constants/connection-type'
  import Btn from './Btn.vue'
  import ServiceIcon from './ServiceIcon.vue'
  import ValueSelect from './ValueSelect.vue'
  import KeypairItem from './KeypairItem.vue'

  const newKeypairItem = (key, val) => {
    key = _.defaultTo(key, '')
    val = _.defaultTo(val, '')

    return {
      key,
      val
    }
  }

  const method_options = [
    { val: '',        label: 'Default (none)' },
    { val: 'GET',     label: 'GET'            },
    { val: 'POST',    label: 'POST'           },
    { val: 'PUT',     label: 'PUT'            },
    { val: 'PATCH',   label: 'PATCH'          },
    { val: 'DELETE',  label: 'DELETE'         },
    { val: 'HEAD',    label: 'HEAD'           },
    { val: 'OPTIONS', label: 'OPTIONS'        }
  ]

  const auth_options = [
    { val: 'none',   label: 'No Auth'      },
    { val: 'basic',  label: 'Basic Auth'   },
    { val: 'bearer', label: 'Bearer Token' }/*,
    { val: 'oauth2', label: 'OAuth 2.0'    }*/
  ]

  export default {
    props: {
      'connection': {
        type: Object,
        required: true
      },
      'is-new': {
        type: Boolean,
        default: false
      }
    },
    components: {
      Btn,
      ServiceIcon,
      ValueSelect,
      KeypairItem
    },
    data() {
      return {
        method_options,
        auth_options,
        name: 'My Connection',
        ename: '',
        description: '',
        connection_type: CONNECTION_TYPE_HTTP,
        method: '',
        url: '',
        auth: 'none',
        username: '',
        password: '',
        token: '',
        access_token: '',
        refresh_token: '',
        expires: '',
        headers: [],
        data: [],
        is_inited: false
      }
    },
    computed: {
      eid() {
        return _.get(this.connection, 'eid', '')
      },
      ctype() {
        return _.get(this.connection, 'connection_type', '')
      },
      curl() {
        return _.get(this.connection, 'connection_info.url', '')
      },
      identifier() {
        var cid = _.get(this.connection, 'ename', '')
        return cid.length > 0 ? cid : _.get(this.connection, 'eid', '')
      },
      is_changed() {
        return true
      }
    },
    mounted() {
      this.$nextTick(() => {
        this.reset()
        this.is_inited = true
      })
    },
    methods: {
      reset() {
        this.name = _.get(this.connection, 'name', '')
        this.ename = _.get(this.connection, 'ename', '')
        this.description = _.get(this.connection, 'description', '')

        _.each(_.get(this.connection, 'connection_info', {}), (val, key) => {
          if (_.isString(val))
            this[key] = val

          if (_.isPlainObject(val))
          {
            _.each(val, (val2, key2) => {
              this[key] = [].concat(this[key]).concat(newKeypairItem(key2, val2))
            })
          }
        })

        // add "ghost" items
        this.data = [].concat(this.data).concat(newKeypairItem())
        this.headers = [].concat(this.headers).concat(newKeypairItem())
      },
      getConnection() {
        var eid = this.eid
        var connection = _.pick(this.$data, ['name', 'ename', 'description', 'connection_type'])
        var connection_info = _.pick(this.$data, ['method', 'url', 'auth', 'username', 'password', 'token', 'access_token', 'refresh_token', 'expires', 'headers', 'data'])

        var data = _.keyBy(this.$data.data, 'key')
        data = _.pickBy(data, (val, key) => { return key.length > 0 })
        data = _.mapValues(data, 'val')

        var headers = _.keyBy(this.$data.headers, 'key')
        headers = _.pickBy(headers, (val, key) => { return key.length > 0 })
        headers = _.mapValues(headers, 'val')

        connection_info.data = data
        connection_info.headers = headers

        return _.assign({}, connection, { eid, connection_info })
      },
      onFormDataItemChange(item, index) {
        if (index == _.size(this.data) - 1)
          this.data = [].concat(this.data).concat(newKeypairItem())

        var arr = [].concat(this.data)
        arr[index] = _.assign({}, item)
        this.data = [].concat(arr)
      },
      onFormDataItemDelete(item, index) {
        var tmp = this.data
        _.pullAt(tmp, [index])
        this.data = []
        this.$nextTick(() => { this.data = [].concat(tmp) })
      },
      onHeaderItemChange(item, index) {
        if (index == _.size(this.headers) - 1)
          this.headers = [].concat(this.headers).concat(newKeypairItem())

        var arr = [].concat(this.headers)
        arr[index] = _.assign({}, item)
        this.headers = [].concat(arr)
      },
      onHeaderItemDelete(item, index) {
        var tmp = this.headers
        _.pullAt(tmp, [index])
        this.headers = []
        this.$nextTick(() => { this.headers = [].concat(tmp) })
      },
      onCancel() {
        this.reset()
        this.$emit('cancel', this.getConnection(), this.connection)
      },
      onSave() {
        this.$emit('submit', this.getConnection())
      }
    }
  }
</script>
