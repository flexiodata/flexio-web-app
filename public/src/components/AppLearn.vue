<template>
  <div class="overflow-y-auto bg-nearer-white">
    <div class="ma4">
      <div class="f3 f2-ns">Let's build a data feed</div>
      <p class="mw7 lh-copy">Welcome to our interactive tutorial. Choose a topic from the drop-down menu to get started.<br>Then, follow the steps below to get a deployable pipe in just a few minutes.</p>
      <div class="mv3 f5 lh-copy">
        <span class="dib mr1">I want to</span>
        <el-select
          placeholder="Select"
          class="f5"
          style="width: 340px"
          @change="onOnboardingItemChange"
          v-model="active_item_id"
        >
          <el-option
            v-for="item in items"
            :key="item.id"
            :label="item.want.replace('I want to ', '')"
            :value="item.id">
          </el-option>
        </el-select>
      </div>
      <onboarding-item
        :item="active_item"
        :api-key="api_key"
        :sdk-options="sdk_options"
        :username="active_username"
      />
    </div>
  </div>
</template>

<script>
  import { mapState, mapGetters } from 'vuex'
  import OnboardingItem from './OnboardingItem.vue'

  const item1 = require('json-loader!yaml-loader!../data/onboarding/copy-file-directory-to-cloud-storage.yml')
  const item2 = require('json-loader!yaml-loader!../data/onboarding/collect-data-from-api.yml')
  const item3 = require('json-loader!yaml-loader!../data/onboarding/process-tabular-data.yml')
  const items = [item1, item2, item3]

  export default {
    components: {
      OnboardingItem
    },
    data() {
      return {
        items,
        active_item_id: ''
      }
    },
    computed: {
      ...mapState([
        'active_user_eid'
      ]),
      active_username() {
        return _.get(this.getActiveUser(), 'user_name', '')
      },
      api_key() {
        var tokens = this.getAllTokens()

        if (tokens.length == 0)
          return ''

        return _.get(tokens, '[0].access_code', '')
      },
      sdk_options() {
        return { baseUrl: 'https://' + window.location.host + '/api/v1' }
      },
      active_item() {
        var item = _.find(this.items, { id: this.active_item_id })
        return _.defaultTo(item, {})
      }
    },
    mounted() {
      this.active_item_id = _.get(this.items, '[0].id', '')
      this.tryFetchTokens()
    },
    methods: {
      ...mapGetters([,
        'getAllTokens',
        'getActiveUser'
      ]),
      tryFetchTokens() {
        this.$store.dispatch('fetchUserTokens', { eid: this.active_user_eid })
      },
      onOnboardingItemChange(id) {
        var item = _.find(this.items, { id })

        this.$store.track('Switched Onboarding Item', {
          title: item.name
        })
      }
    }
  }
</script>
